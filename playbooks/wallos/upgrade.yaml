# @format

# Wallos
# Upgrade Wallos subscription management server.
---
- name: Update apt cache, upgrade packages and remove unused dependencies
  ansible.builtin.apt:
    update_cache: true
    upgrade: dist
    autoremove: true
    purge: true

- name: Pull Wallos git repository
  ansible.builtin.git:
    repo: https://github.com/ellite/Wallos.git
    dest: /opt/wallos # noqa: latest
    force: true

- name: Ensure owner of wallos application directory is set
  ansible.builtin.file:
    path: /opt/wallos
    owner: "{{ nfs_user_name }}"
    group: "{{ nfs_user_name }}"
    mode: "0740"
    recurse: true
    follow: false
    state: directory

- name: Run wallos migration
  ansible.builtin.command:
    chdir: /opt/wallos/endpoints/db
    cmd: php migrate.php
  register: wallos_migration
  changed_when: "'No migrations to run.' not in wallos_migration.stdout_lines"
